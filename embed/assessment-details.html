<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Assessment Details</title>
  <link rel="stylesheet" media="all" href="https://uq-business-school.github.io/styleguide/css/superstyle.css" />
  <style>
    .uq-button {color: #fff;}
    .bb-link-hover {background-color: transparent!important;}
    .jacson-preload{position: absolute; top: 100px; left: 5%; font-size: 1.4rem; display: block; width: 90%; margin: 0 auto; text-align: center;}
    body{min-height: 1000px;}
    
    /* CSS notes from original file */
    .icon-list{list-style-type:none;padding-left:0;margin-top:0;}
    .icon-list--inline{display: block; margin-block-start: 1rem;margin-block-end: 1rem;padding-inline-start: 40px;margin-inline-start: 0px; margin-inline-end: 0px; unicode-bidi: isolate;}
    .margin--bottom-reset{margin-bottom:0!important;}
    .spacing--bottom-s{padding-bottom: var(--spacing-s);}
    
    /* Force remove all bullets/discs from special indicators */
    .special-indicators ul,
    .special-indicators li,
    #specialIndicators,
    #specialIndicators li {
      list-style: none !important;
      list-style-type: none !important;
      padding-left: 0 !important;
      margin-left: 0 !important;
    }
    
    /* Ensure proper spacing for icon and text */
    #specialIndicators li {
      display: inline-block;
      margin-right: 1rem;
      margin-bottom: 0.5rem;
    }
    
    #specialIndicators li span.uq-icon {
      margin-right: 0.5rem;
    }
    
    /* Loading and Error States */
    .loading-spinner {
      display: inline-block;
      width: 40px;
      height: 40px;
      border: 4px solid #f3f3f3;
      border-top: 4px solid #51247a;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 20px auto;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .error-message {
      background: #ffebee;
      color: #c62828;
      padding: 1rem;
      border-radius: 4px;
      border-left: 4px solid #c62828;
      margin: 1rem 0;
    }
    
    .loading-message {
      text-align: center;
      padding: 2rem;
      color: #666;
    }
    
    .hidden {
      display: none;
    }
    
    /* Enhanced styling for assessment details */
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 1rem;
    }
    
    .assessment-header {
      background: linear-gradient(135deg, #51247a 0%, #8c6bc8 100%);
      color: white;
      padding: 1.5rem;
      border-radius: 8px;
      margin-bottom: 2rem;
    }
    
    .assessment-title {
      font-size: 2rem;
      font-weight: bold;
      margin-bottom: 0.5rem;
    }
    
    .special-indicators {
      margin-top: 1rem;
    }
    
    .special-indicator {
      display: inline-block;
      background: rgba(255, 255, 255, 0.2);
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      font-size: 0.9rem;
      margin-right: 0.5rem;
    }
    
    .details-table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 2rem;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .details-table th {
      background-color: #d7d1cc;
      text-align: center;
      padding: 1rem;
      border: 1px solid #f7f6f5;
      font-weight: bold;
    }
    
    .details-table td {
      text-align: center;
      padding: 1rem;
      border: 1px solid #f7f6f5;
      background: white;
    }
    
    .section {
      background: white;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .section h6 {
      color: #51247a;
      font-size: 1.2rem;
      margin-bottom: 1rem;
      border-bottom: 2px solid #51247a;
      padding-bottom: 0.5rem;
    }
    
    .section-content {
      line-height: 1.6;
      color: #333;
    }
    
    .due-date {
      color: #d32f2f;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Loading State -->
    <div id="loadingState" class="loading-message">
      <div class="loading-spinner"></div>
      <p>Loading assessment details...</p>
    </div>

    <!-- Error State -->
    <div id="errorState" class="error-message hidden">
      <p>Error loading assessment details. Please check the URL or try again later.</p>
    </div>

    <!-- Main Content (Hidden initially) -->
    <div id="mainContent" class="hidden">
      <!-- Hidden assessment ID for reference -->
      <p id="assessmentId" style="display: none;"></p>
      
      <!-- Assessment Header -->
      <div class="assessment-header">
        <h5 style="margin: 0 0 0.5rem 0; color: white; font-size: 1rem;">Assessment Details</h5>
        <div class="assessment-title" id="assessmentTitle">Loading...</div>
        <div class="special-indicators">
          <ul class="icon-list icon-list--inline margin--bottom-reset spacing--bottom-s" id="specialIndicators">
            <!-- Populated dynamically -->
          </ul>
        </div>
      </div>

      <!-- Assessment Details Table -->
      <table class="details-table">
        <thead>
          <tr>
            <th>Mode</th>
            <th>Category</th>
            <th>Weight</th>
            <th>Due Date</th>
            <th>Learning Outcomes</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td id="mode">Loading...</td>
            <td id="category">Loading...</td>
            <td id="weighting">Loading...</td>
            <td id="dueDate">Loading...</td>
            <td id="learningObjectives">Loading...</td>
          </tr>
        </tbody>
      </table>

      <!-- Task Description -->
      <div class="section">
        <h6>Task Description</h6>
        <div class="section-content" id="taskDescription">
          Loading...
        </div>
      </div>

      <!-- Submission Guidelines -->
      <div class="section">
        <h6>Submission Guidelines</h6>
        <div class="section-content" id="submissionGuidelines">
          Loading...
        </div>
      </div>

      <!-- Deferral or Extension -->
      <div class="section">
        <h6>Deferral or Extension</h6>
        <div class="section-content" id="deferralOrExtension">
          Loading...
        </div>
      </div>

      <!-- Late Submission -->
      <div class="section">
        <h6>Late Submission</h6>
        <div class="section-content" id="lateSubmission">
          Loading...
        </div>
      </div>
    </div>
  </div>

  <script>
    // Dynamic assessment details controller
    (function () {
      const allowedDomains = [
        "learn.uq.edu.au",
        "saas-stage.learn.uq.edu.au"
      ];
      const currentHost = window.location.hostname;

      // PREVIEW INSTRUCTION ONLY
      if (allowedDomains.includes(currentHost)) {
        const preloadMessage = document.createElement("p");
        preloadMessage.className = "jacson-preload";
        preloadMessage.textContent = 'Click on the "Save" button at the top-right to finish inserting the Assessment Details';
        document.body.appendChild(preloadMessage);
        return; // Stop further execution
      }

      // PRODUCTION BEHAVIOUR (CDN delivery with full functionality)
      document.addEventListener('DOMContentLoaded', async () => {
        const url = window.location.href;
        const loadingState = document.getElementById('loadingState');
        const errorState = document.getElementById('errorState');
        const mainContent = document.getElementById('mainContent');

        try {
          // Extract course code and assessment index from URL
          const match = url.match(/\/courses\/([^\/]+)\//);
          if (!match) {
            throw new Error('Course code not detected in URL');
          }

          const fullCourseCode = match[1];  // e.g. "BSAN7209_7560_60200"
          const [courseCode, semesterCode, classCode] = fullCourseCode.split('_');
          
          if (!courseCode || !semesterCode || !classCode) {
            throw new Error('Invalid course code format');
          }

          // Try to extract assessment index from URL or filename
          // This could be from URL parameters, hash, or filename pattern
          let assessmentIndex = 0; // Default to first assessment
          
          // Check for assessment index in URL hash or search params
          const urlParams = new URLSearchParams(window.location.search);
          const hashMatch = window.location.hash.match(/assessment-(\d+)/);
          const paramIndex = urlParams.get('assessment');
          
          if (hashMatch) {
            assessmentIndex = parseInt(hashMatch[1]);
          } else if (paramIndex) {
            assessmentIndex = parseInt(paramIndex);
          } else {
            // Try to extract from filename pattern (e.g., assessment-details-0_v001.html)
            const filenameMatch = window.location.pathname.match(/assessment-details-(\d+)/);
            if (filenameMatch) {
              assessmentIndex = parseInt(filenameMatch[1]);
            }
          }

          // Construct JSON path
          const jsonPath = `https://uqgblaze.github.io/jacson/profiles/${semesterCode}/${courseCode}-${classCode}-${semesterCode}.json`;
          
          // Fetch course data
          const response = await fetch(jsonPath);
          if (!response.ok) {
            throw new Error(`Failed to fetch course data: ${response.status}`);
          }
          
          const courseData = await response.json();
          
          // Check if assessment exists
          if (!courseData.assessments || !courseData.assessments[assessmentIndex]) {
            throw new Error(`Assessment ${assessmentIndex} not found in course data`);
          }
          
          // Render the assessment data
          renderAssessmentData(courseData.assessments[assessmentIndex], assessmentIndex);
          
          // Show main content and hide loading
          loadingState.classList.add('hidden');
          mainContent.classList.remove('hidden');
          
        } catch (error) {
          console.error('Error loading assessment data:', error);
          loadingState.classList.add('hidden');
          errorState.classList.remove('hidden');
          errorState.querySelector('p').textContent = `Error: ${error.message}`;
        }
      });

      function renderAssessmentData(assessment, index) {
        // Set assessment ID (hidden)
        document.getElementById('assessmentId').textContent = `assessment_detail_section_id_${index}`;

        // Set assessment title
        document.getElementById('assessmentTitle').textContent = assessment.assessment_title;

        // Render special indicators
        const specialIndicators = document.getElementById('specialIndicators');
        specialIndicators.innerHTML = '';
        if (assessment.special_indicators && assessment.special_indicators.length > 0) {
          assessment.special_indicators.forEach(indicator => {
            const li = document.createElement('li');
            
            // Create span element for the icon
            const iconSpan = document.createElement('span');
            
            // Set the proper UQ icon classes using special_indicators_class
            const iconClass = indicator.special_indicators_class || '';
            iconSpan.className = `uq-icon uq-icon--light uq-${iconClass}`;
            
            // Add text content
            const textNode = document.createTextNode(indicator.special_indicator_text);
            
            // Append icon and text to li
            li.appendChild(iconSpan);
            li.appendChild(textNode);
            
            specialIndicators.appendChild(li);
          });
        }

        // Populate table data
        document.getElementById('mode').textContent = assessment.mode || 'N/A';
        document.getElementById('category').textContent = assessment.category || 'N/A';
        
        // Clean up weighting
        const weighting = assessment.weighting ? assessment.weighting.replace(/<\/?dd>/g, '') : 'N/A';
        document.getElementById('weighting').textContent = weighting;
        
        // Clean up and highlight due date
        const dueDate = assessment.due_date ? assessment.due_date.replace(/<\/?dd>|<\/?p>/g, '').trim() : 'N/A';
        const dueDateElement = document.getElementById('dueDate');
        dueDateElement.innerHTML = `<span class="due-date">${dueDate}</span>`;
        
        document.getElementById('learningObjectives').textContent = assessment.learning_objectives || 'N/A';

        // Populate sections
        populateSection('taskDescription', assessment.task_description);
        populateSection('submissionGuidelines', assessment.submission_guidelines);
        populateSection('deferralOrExtension', assessment.deferral_or_extension);
        populateSection('lateSubmission', assessment.late_submission);
      }

      function populateSection(elementId, content) {
        const element = document.getElementById(elementId);
        if (content) {
          // Clean up any collapsible wrapper HTML that might be present
          let cleanContent = content
            .replace(/<div class="collapsible[^>]*>/, '')
            .replace(/<button class="collapsible__toggle"[\s\S]*?<\/button>/, '')
            .replace(/<\/div>$/, '');
          
          element.innerHTML = cleanContent;
        } else {
          element.innerHTML = '<p><em>No information available, and/or or this course profile is not yet public, and/or or this course profile has not yet been compiled by JacSON.</em></p>';
        }
      }
    })();
  </script>
</body>
</html>
